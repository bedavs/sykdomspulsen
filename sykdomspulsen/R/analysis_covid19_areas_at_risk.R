#' analysis_covid19_areas_at_risk
#' @param data a
#' @param argset a
#' @param schema a
#' @export
analysis_covid19_areas_at_risk <- function(data, argset, schema) {
  # tm_run_task("analysis_covid19_areas_at_risk")

  if(plnr::is_run_directly()){
    sc::tm_update_plans("analysis_covid19_areas_at_risk")

    index_plan <- 1
    data <- sc::tm_get_data("analysis_covid19_areas_at_risk", index_plan=index_plan)
    argset <- sc::tm_get_argset("analysis_covid19_areas_at_risk", index_plan=index_plan, index_argset = 1)
    schema <- sc::tm_get_schema("analysis_covid19_areas_at_risk")
  }


  # this code
  # a) only works for "total age groups" (change it to all age groups) # total & age groups?
  # start changing the data
  # MSIS
  d <- copy(data$covid19$msis)

  d[, n_lag1 := shift(n, type="lag")]
  d[, n_lag2 := shift(n, n=2L, type="lag")]


  yrwks <- unique(d$yrwk)

  d[,baseline := pmax(1,ceiling((n_lag1+n_lag2)/2))]
  d[,threshold := qpois(0.975, lambda = baseline)]

  d[,n_status:=ifelse(n > threshold,"high","normal")]

  d_msis <- d[,c("location_code","yrwk","age", "n","baseline","threshold","n_status" )]
  setnames(d_msis, c("n",
                     "baseline",
                     "threshold"),
           c("n",
             "n_baseline_expected",
             "n_baseline_thresholdu0"))

  d_msis[,tag_outcome:="msis"]
  d_msis[,n_denominator:=NA]
  d_msis[,pr100:=NA]
  d_msis[,pr100_baseline_expected:=NA]
  d_msis[,pr100_baseline_thresholdu0:=NA]



  # NORSYSS
  d <- copy(data$covid19$norsyss)
  d[,pr100:=100*n/consult_with_influenza]

  d[is.nan(pr100), pr100:=0]
  d[, n_lag1 := shift(n, type="lag"), by=.(tag_outcome,age)]
  d[, n_lag2 := shift(n, n=2L, type="lag"), by=.(tag_outcome,age)]
  d[, consult_with_influenza_lag1 := shift(consult_with_influenza, type="lag"), by=.(tag_outcome,age)]
  d[, consult_with_influenza_lag2 := shift(consult_with_influenza, n=2L, type="lag"), by=.(tag_outcome,age)]


  d[,pr100_baseline := pmax(0.01,100*(n_lag1+n_lag2)/
                             (consult_with_influenza_lag1+consult_with_influenza_lag2))]
  d[, n_baseline_expected := ceiling(pr100_baseline*consult_with_influenza/100)]

  d[,n_threshold := qpois(0.975, lambda=n_baseline_expected)]
  d[,pr100_threshold := 100*n_threshold/consult_with_influenza]
  d[is.nan(pr100_threshold),pr100_threshold:=0]
  d[pr100_threshold>100,pr100_threshold:=100]

  d[,n_status:=ifelse(pr100 > pr100_threshold,"high","normal")]

  d_norsyss <- d[,c("tag_outcome",
                    "location_code",
                    "yrwk",
                    "age",
                    "n",
                    "consult_with_influenza",
                    "n_baseline_expected",
                    "n_threshold",
                    "pr100",
                    "pr100_baseline",
                    "pr100_threshold",
                    "n_status")]

  setnames(d_norsyss,
           c(
             "consult_with_influenza",
             "n_threshold",
             "pr100",
             "pr100_baseline",
             "pr100_threshold"),
           c(
             "n_denominator",
             "n_baseline_thresholdu0",
             "pr100",
             "pr100_baseline_expected",
             "pr100_baseline_thresholdu0"))



  retval <- rbind(
    d_msis,
    d_norsyss)

  retval[, granularity_time := "week"]

  #############################
  # b) it doesn't provide the output in the way we want it
  schema$output$db_field_types

  # this will fill in a lot of standard columns
    fill_in_missing(retval)

    # schema$output$db_upsert_load_data_infile(retval)
    return(retval)
}


analysis_covid19_areas_at_risk_function_factory <- function(loc){
  # snapshots the variable 'loc' and fixes in the following
  # function
  force(loc)

  function(){
    retval <- list()

    retval$msis <- sc::tbl("prelim_data_covid19_msis_by_time_location") %>%
      dplyr::filter(granularity_time=="day") %>%
      dplyr::filter(location_code %in% !!loc) %>%
      dplyr::filter(date >= "2020-03-09") %>%
      dplyr::group_by(location_code, age, yrwk) %>%
      dplyr::summarize(n=sum(n)) %>%
      dplyr::collect() %>%
      sc::latin1_to_utf8()

    retval$norsyss <- sc::tbl("data_norsyss") %>%
      dplyr::filter(granularity_time=="day") %>%
      dplyr::filter(location_code %in% !!loc) %>%
      dplyr::filter(date >= "2020-03-09") %>%
      dplyr::filter(tag_outcome %in% c("covid19_vk_ote", "covid19_r991_vk_ote", "covid19_r992_vk_ote")) %>%
      dplyr::select(tag_outcome,location_code, age, yrwk, n, consult_with_influenza) %>%
      dplyr::group_by(tag_outcome,location_code, age, yrwk) %>%
      dplyr::summarize(n=sum(n), consult_with_influenza=sum(consult_with_influenza)) %>%
      dplyr::collect() %>%
      sc::latin1_to_utf8()

    # make sure they both have the same yrwks
    yrwks <- intersect(unique(retval$msis$yrwk), unique(retval$norsyss$yrwk))
    retval$msis <- retval$msis[yrwk %in% yrwks]
    retval$norsyss <- retval$norsyss[yrwk %in% yrwks]

    # sort them
    setorder(retval$msis, location_code, age, yrwk)
    setorder(retval$norsyss, tag_outcome, location_code, age, yrwk)

    retval
  }
}

analysis_covid19_areas_at_risk_plans <- function(){

  # these are the areas we are interested in
  locs <- norway_locations_long()$location_code
  locs <- locs[!locs %in% "norway"]
  locs <- locs[!stringr::str_detect(locs,"^ward")]

  list_plan <- list()
  for(loc in locs){
    # create a new plan
    list_plan[[length(list_plan)+1]] <- plnr::Plan$new()

    # add in the data
    list_plan[[length(list_plan)]]$add_data(
      name = "covid19",
      fn=analysis_covid19_areas_at_risk_function_factory(
        loc = loc
      )
    )

    # what do you want to do with the data?
    list_plan[[length(list_plan)]]$add_analysis(
      fn = analysis_covid19_areas_at_risk,
      location_code = loc # giving us information that is available through 'argset'
    )
  }

  return(list_plan)
}
